{% load static %}

{% block extra_css %}
  <link href="{% static 'scheduler/css/jquery.datetimepicker.css' %}" rel='stylesheet' />
{% endblock %}

{% block extra_js %}
  <script src="{% static 'scheduler/js/jquery.datetimepicker.full.js' %}"></script>
{% endblock %}

  <!-- Modal Trigger -->
  <!-- <a class="waves-effect waves-light btn modal-trigger" href="#modal1">Modal</a> -->

  <!-- Modal Structure -->
<!--   <div id="modal1" class="modal">
    <div class="modal-content">
 -->
<div id="modal1">
 
  <button data-formType="appointment" id="switch_form">Schedule Event</button>

  <form id="appointment_form" class="active" action="." method="POST">
    {% csrf_token %}

    {{ forms.appointment.as_p }}

    <p><input type="submit" value="Schedule"></p>
  </form>

  <form id="event_form" class="hidden" action="." method="POST">
    {% csrf_token %}

    {{ forms.event.as_p }}

    <p><input type="submit" value="Schedule"></p>
  </form>
</div>

<!--     </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
    </div>
  </div> -->

<!-- TODO: start/end for event should be conditional
  if all day unchecked, show start / end
https://www.fusionbox.com/blog/detail/creating-conditionally-required-fields-in-django-forms/577/
-->

<!-- TODO: place CSS and Scripts in folders. Use \{\% extra js \%\} in this template -->
<style type="text/css">
  .hidden {
    height: 0px;
    visibility: hidden;
  }
  .active {
    visibility: visible;
  }
</style>

<script type="text/javascript">
  // keep create obj to keep track of initial object + any changes + conversion
  function testin(info) {
    x = new Object;
    x.start = info.start;
    x.end = info.end;
    x.allDay = info.allDay;
  }
</script>

<script type="text/javascript">
  // addEventListener to switch_form button
  document.getElementById('switch_form').addEventListener('click', function() {
    var reverse_of = {'appointment': 'event', 'event': 'appointment'};
    var active_form = this.dataset.formtype;
    var inactive_form = reverse_of[this.dataset.formtype];

    document.getElementById(active_form + '_form').classList.remove('active');
    document.getElementById(active_form + '_form').classList.add('hidden');
    document.getElementById(inactive_form + '_form').classList.remove('hidden');
    document.getElementById(inactive_form + '_form').classList.add('active');

    // change what the button displays
    this.dataset.formtype = inactive_form;
    this.innerHTML = "Schedule " + active_form.charAt(0).toUpperCase() + active_form.slice(1);
  });
</script>

<script type="text/javascript">
  $('#id_service').change(function() {

    var service_id = $(this).val();

    // only bother with ajax if an option selected
    if (service_id) {

      var active_form = $(this).closest('form');
      var service_start = $(active_form).find('.schedule_start_field');
      var service_end = $(active_form).find('.schedule_end_field');

      $.ajax({
        type: 'GET',
        // TODO - add below as data-attr
        url: 'http://127.0.0.1:8000/ajax/event_service_duration/',
        data: {
          'service_id': service_id
        },
        success: function (response) {
          var duration = JSON.parse(response['duration']);
          // var start = moment($(service_end).attr('data-start'));
          var s = $(service_start).val();
          var dt = moment(s, 'DD/MM/YY HH:mm');
          var end = dt.add(duration, 'minutes');
          // TODO: store the formats as a global variable
          $(service_end).val(end.format('DD/MM/YYYY HH:mm'));

        },
        error: function (xhr, status, error) {
          console.log("error");
          console.log(status, error);
        }
      });
    }
  })
</script>

<!--       // var end_fields = document.querySelectorAll('.schedule_end_field');
      // for (var i = end_fields.length - 1; i >= 0; i--) {
      //   end_fields[i].setAttribute('data-start', moment(info.end).toISOString());
      // } -->

<!-- <script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    var options = {};
    var elems = document.querySelectorAll('.modal');
    var instances = M.Modal.init(elems, options);
  })
</script> -->